<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Orientation and Motion Example with Audio (Howler.js)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        h1 {
            margin-bottom: 20px;
        }
        #output-orientation, #output-motion, #output-volume {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        #rotation-bar {
            width: 300px;
            height: 30px;
            background-color: #ddd;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
        }
        #indicator {
            position: absolute;
            height: 100%;
            width: 50%;
            background-color: #007bff;
            left: 50%;
            transform-origin: center;
            transition: transform 0.1s;
        }
        #startButton, #playButton, #restartButton {
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px;
        }
    </style>
    <!-- Include Howler.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>

    <h1>Rotate and Move Your Phone</h1>
    <div id="output-orientation">Orientation: 0°</div>
    <div id="output-motion">Acceleration: 0 m/s²</div>
    <div id="output-volume">Volume: 0.5</div>
    <div id="rotation-bar">
        <div id="indicator"></div>
    </div>
    <button id="startButton">Start</button>
    <button id="playButton">Play Audio</button>
    <button id="restartButton">Restart</button>

    <script>
        // Initialize the Howl object
        var sound = new Howl({
            src: ['test.mp3'],
            volume: 0.5 // initial volume
        });

        const playButton = document.getElementById('playButton');
        const restartButton = document.getElementById('restartButton');
        const outputVolume = document.getElementById('output-volume'); // Reference for volume output

        // Add event listener to the button to request permissions on user gesture
        document.getElementById('startButton').addEventListener('click', () => {
            requestOrientationPermission();
        });

        playButton.addEventListener('click', () => {
            sound.play();
        });

        restartButton.addEventListener('click', () => {
            sound.stop();
            sound.play();
        });

        function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // Request permission for device orientation
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            initializeOrientationListener();
                        } else {
                            alert('Permission denied for accessing orientation data.');
                        }
                    })
                    .catch(console.error);
            } else {
                // No permission required for non-iOS devices
                initializeOrientationListener();
            }
        }

        function initializeOrientationListener() {
            // Handle device orientation events
            window.addEventListener("deviceorientation", handleOrientation);

            function handleOrientation(event) {
                const gamma = event.gamma; // Left-to-right tilt (gamma)

                // Update the text output for orientation
                const outputOrientation = document.getElementById('output-orientation');
                outputOrientation.textContent = `Orientation: ${gamma.toFixed(2)}°`;

                // Move the indicator to reflect rotation
                const indicator = document.getElementById('indicator');
                let position = gamma; // gamma is between -90 and 90
                position = Math.max(-45, Math.min(45, position)); // Clamp between -45 and 45
                let transformValue = (position / 45) * 100; // Map to percentage
                indicator.style.transform = `translateX(${transformValue}%)`;

                // Map gamma (-50 to 50) to volume (0 to 1)
                let volume;
                if (gamma <= -50) {
                    volume = 0;
                } else if (gamma >= 50) {
                    volume = 1;
                } else {
                    // Normalize gamma to be between -50 and 50, then map to volume
                    volume = (gamma + 50) / 100; // gamma=-50 -> volume=0, gamma=50 -> volume=1
                }

                // Set the volume on the Howl object
                sound.volume(volume);

                // Update the displayed volume for debugging
                outputVolume.textContent = `Volume: ${volume.toFixed(2)}`;
            }
        }

        // Optional: Motion listener for device motion (acceleration)
        window.addEventListener("devicemotion", handleMotion);

        function handleMotion(event) {
            const acceleration = event.accelerationIncludingGravity; // Get the acceleration values

            // Update the text output for motion
            const outputMotion = document.getElementById('output-motion');
            outputMotion.textContent = `Acceleration: ${acceleration.x.toFixed(2)} m/s² (X-axis)`;
        }
    </script>

</body>
</html>